{
  "meta": {
    "name": "Admin CSV Import Integrity & UX",
    "description": "A guided CSV import flow that preserves data integrity while improving admin usability.",
    "created": "2026-01-09",
    "version": "1.0.0",
    "interview_summary": "Build a first-class admin CSV import experience for the data team that prevents referential errors, surfaces clear validations, and provides resolution steps for missing company IDs. Maintain v1_company_information as the master table, use v1_company_mapping as an alias resolver, and normalize financial period data while preserving raw CSV values. The goal is a reliable, user-friendly workflow that reduces import errors before data reaches user-facing views."
  },
  "config": {
    "priority_order": ["critical", "high", "medium", "low"],
    "categories": ["architectural", "integration", "functional", "ui", "testing"]
  },
  "features": [
    {
      "id": "csv-001",
      "category": "architectural",
      "priority": "critical",
      "description": "Add a period_label text column to v1_company_revenue to store raw CSV periods (e.g., FY-2022), while keeping normalized period_type and period_year for analytics.",
      "acceptance_criteria": [
        "Database has a v1_company_revenue.period_label column of type text and it is nullable.",
        "Existing period_type and period_year remain the canonical normalized fields for filtering and reporting."
      ],
      "verification_steps": [
        "Run the migration and confirm period_label exists with \"\\d v1_company_revenue\" in psql or Supabase SQL editor.",
        "Insert a sample row with period_label = FY-2022 and verify the row is retrievable."
      ],
      "dependencies": [],
      "notes": "Use sql-migrations/ for schema changes and keep RLS policies unchanged unless required by the new column.",
      "passes": false
    },
    {
      "id": "csv-002",
      "category": "integration",
      "priority": "critical",
      "description": "Parse revenue CSV period values (FY/Q/H formats) into period_type and period_year, and store the raw value in period_label during import validation.",
      "acceptance_criteria": [
        "CSV values like FY-2022, Q1-2024, and H2-2025 are accepted and parsed into period_type and period_year.",
        "Unrecognized period formats produce a blocking validation error with the row number and value.",
        "period_label preserves the exact raw CSV period string."
      ],
      "verification_steps": [
        "Upload v1_company_revenue.csv and confirm FY-2022 maps to period_type=FY, period_year=2022, period_label=FY-2022.",
        "Upload a CSV row with period=BAD-2022 and confirm validation fails with a clear error message."
      ],
      "dependencies": ["csv-001"],
      "notes": "Parsing should occur during CSV validation/diff so errors appear before import.",
      "passes": false
    },
    {
      "id": "csv-003",
      "category": "functional",
      "priority": "critical",
      "description": "Introduce a Missing Company Resolution step that blocks import when company_id values are missing from v1_company_information.",
      "acceptance_criteria": [
        "Imports to any table with company_id (except v1_company_information) stop at resolution when unknown IDs are present.",
        "Resolution step lists missing IDs grouped into: invalid placeholders, mapping-only, and orphaned.",
        "User cannot proceed to Review until all missing IDs are resolved or removed."
      ],
      "verification_steps": [
        "Upload v1_company_employee_count.csv and confirm missing IDs appear in the resolution step with blocking status.",
        "Resolve or remove all missing IDs and confirm the flow continues to Review."
      ],
      "dependencies": [],
      "notes": "Invalid placeholders include values like #REF!, Not_AM_Company, and nan.",
      "passes": false
    },
    {
      "id": "csv-004",
      "category": "integration",
      "priority": "high",
      "description": "Use v1_company_mapping as an alias resolver to help fix missing company IDs, including suggestions for canonical company_id and company_name.",
      "acceptance_criteria": [
        "If a company_id exists in v1_company_mapping but not in v1_company_information, it is flagged as mapping-only (warning) with suggested company_name.",
        "Resolution UI provides an option to export a seed CSV for v1_company_information using mapping values.",
        "Resolution UI allows marking mapping-only IDs for creation as Pending companies (stub records)."
      ],
      "verification_steps": [
        "Upload a CSV containing ASTMCI8138 and confirm it appears as mapping-only with a suggested name.",
        "Export the seed CSV and verify it includes company_id and company_name columns for missing records."
      ],
      "dependencies": ["csv-003"],
      "notes": "v1_company_mapping remains an alias table and is not treated as the master source of truth.",
      "passes": false
    },
    {
      "id": "csv-005",
      "category": "functional",
      "priority": "high",
      "description": "Treat non-persisted CSV columns (e.g., company_name, country) as validation-only fields, and surface them clearly in the validation UI.",
      "acceptance_criteria": [
        "If company_name is present in the CSV, mismatches against v1_company_information trigger a warning.",
        "Validation UI shows a list of ignored columns and explains they are used for validation only (not stored).",
        "Ignored columns do not block import unless they conflict with required validations."
      ],
      "verification_steps": [
        "Upload a CSV with company_name that does not match the company_id and confirm a warning appears.",
        "Confirm the UI lists ignored columns and indicates they are not persisted."
      ],
      "dependencies": [],
      "notes": "Avoid validating a generic country column unless the table explicitly defines its meaning.",
      "passes": false
    },
    {
      "id": "csv-006",
      "category": "ui",
      "priority": "high",
      "description": "Add a dedicated Resolution step UI between Validation and Review, with counts, filters, and actions to fix missing companies.",
      "acceptance_criteria": [
        "Wizard steps display Upload → Validate → Resolve → Review → Import.",
        "Resolution step shows counts by category (invalid, mapping-only, orphaned) and provides per-ID actions.",
        "Continue button is disabled until all blocking issues are resolved."
      ],
      "verification_steps": [
        "Navigate the import wizard and confirm the new Resolve step appears when missing IDs are detected.",
        "Attempt to proceed with unresolved blocking issues and confirm the UI prevents it."
      ],
      "dependencies": ["csv-003", "csv-004"],
      "notes": "UI should be optimized for batch resolution (select all, export seed, etc.).",
      "passes": false
    },
    {
      "id": "csv-007",
      "category": "ui",
      "priority": "medium",
      "description": "Improve validation UX with grouped errors, exportable error reports, and accurate CSV preview parsing.",
      "acceptance_criteria": [
        "Validation UI groups errors by type (missing required, invalid ref, unknown company_id, period parse errors).",
        "User can export a CSV or JSON report of validation errors with row numbers.",
        "Preview uses PapaParse (or equivalent) so quoted commas render correctly."
      ],
      "verification_steps": [
        "Upload a CSV with multiple error types and confirm the groups and counts are accurate.",
        "Export an error report and verify it includes row, column, and message fields."
      ],
      "dependencies": [],
      "notes": "Keep the preview lightweight; it should not mutate data.",
      "passes": false
    },
    {
      "id": "csv-008",
      "category": "testing",
      "priority": "medium",
      "description": "Add unit and API tests for period parsing, missing-company resolution, and mapping-based suggestions.",
      "acceptance_criteria": [
        "Unit tests cover FY/Q/H period formats and reject invalid patterns.",
        "API tests for /api/admin/csv-diff verify missing company detection and mapping-only classification.",
        "Tests fail before the implementation and pass afterward."
      ],
      "verification_steps": [
        "Run the test suite and confirm new tests pass.",
        "Simulate an invalid period and confirm the parser test fails without the implementation."
      ],
      "dependencies": ["csv-002", "csv-003", "csv-004"],
      "notes": "Use existing csv-diff test patterns in src/app/api/admin/csv-diff/__tests__/route.test.ts.",
      "passes": false
    }
  ]
}
