# E2E Testing: Publish Flow
**Date:** 2025-12-27
**Tester:** Claude (automated)
**Browser:** Chrome (desktop)
**Environment:** localhost:3000

## Test Account
- Email: `hi+fmb@aaronbaker.co`
- Contractor: FMB (Hmailton, ON)

---

## Issues Found

### Issue #1: Stale credentials in browser (Minor)
**Location:** Login page
**Description:** Old credentials were auto-filled that no longer work
**Impact:** Low - one-time inconvenience
**Status:** Working as expected (browser behavior)

---

### Issue #2: Images missing `sizes` prop (Performance)
**Location:** Dashboard, Project pages
**Description:** Multiple Next.js Image components have `fill` but missing `sizes` prop
**Console Warning:**
```
Image with src "..." has "fill" but is missing "sizes" prop.
Please add it to improve page performance.
```
**Impact:** Medium - affects Core Web Vitals (LCP)
**Fix:** Add `sizes` prop to all Image components with `fill`

---

### Issue #3: "Hmailton" typo (Data Quality)
**Location:** Dashboard header, project cards, preview panel
**Description:** Location shows "Hmailton, ON" - likely should be "Hamilton, ON"
**Impact:** Low - appears to be test data issue, not code bug
**Status:** Verify if this is contractor profile data

---

### Issue #4: Quick action chip truncated (UI)
**Location:** Project edit page - chat interface
**Description:** "How did you fix i..." is cut off
**Impact:** Low - cosmetic
**Fix:** Either use shorter text or add ellipsis with tooltip

---

### Issue #5: Short description in preview (Content)
**Location:** Project preview panel
**Description:** Description is only ~2 sentences for a portfolio piece
**Impact:** Medium - affects SEO and user engagement
**Note:** May be data-dependent, not a code bug

---

### Issue #6: Publish button looks enabled but is disabled (CRITICAL) ✅ FIXED
**Location:** `/projects/[id]/edit` page
**Description:**
- The Publish button has `disabled={true}` in the DOM
- But visually it appears fully enabled (teal color, no opacity change)
- Clicking produces no feedback whatsoever
- No tooltip explains why publishing is blocked

**Root Cause:**
Button is disabled when `completeness.canGenerate` is false. This requires:
- At least 1 photo (25%)
- 55% completeness threshold
- Quality gate: 80+ chars combined context, 2+ materials

**Impact:** CRITICAL - Users cannot understand why they can't publish

**✅ FIX APPLIED:**
Added Tooltip wrapper to Publish button showing missing requirements:
- File: `src/app/(contractor)/projects/[id]/edit/page.tsx`
- Tooltip displays: "Complete these to publish:" with list of missing fields
- Quality issues shown in amber warning color

---

## Test Coverage

| Area | Status | Notes |
|------|--------|-------|
| Login | ✅ Pass | Works with valid credentials |
| Dashboard | ✅ Pass | Stats and projects load correctly |
| Project Edit | ✅ Pass | Chat interface loads |
| Preview Panel | ✅ Pass | Shows project content |
| Publish Button | ❌ Fail | Disabled styling broken |
| Actual Publish | ⏸️ Blocked | Cannot test due to Issue #6 |

---

## Recommendations

1. **Immediate:** Fix disabled button styling (Issue #6)
2. **Short-term:** Add tooltip to explain publish requirements
3. **Medium-term:** Add `sizes` to Image components (Issue #2)
4. **Consider:** Progress checklist showing what's needed to publish

---

---

### Issue #7: Chat API returns 503 (CRITICAL) ✅ FIXED
**Location:** `/api/chat/edit`
**Description:**
- POST to `/api/chat/edit` returns 503 initially
- Root cause was NOT the API key - it was Gemini schema validation error

**Actual Error:**
```
Error [AI_APICallError]: Invalid value at 'tools[0].function_declarations[7].parameters.properties[0].value.items.one_of[1].properties[1].value.any_of[0].enum[0]' (TYPE_STRING), 2
```

**Root Cause:**
The `headingLevelSchema` in `/src/lib/content/description-blocks.ts` used numeric literals:
```typescript
const headingLevelSchema = z.union([z.literal(2), z.literal(3)]);
```

Gemini API requires all enum values to be **strings**, not numbers. When Zod converts this to JSON Schema, `z.literal(2)` becomes `{"const": 2}` which Gemini rejects.

**✅ FIX APPLIED:**
Changed numeric literals to string literals:
```typescript
const headingLevelSchema = z.union([z.literal('2'), z.literal('3')]);
```

Updated 5 files to use string comparisons:
- `src/lib/content/description-blocks.ts`
- `src/lib/content/description-blocks.client.ts`
- `src/components/edit/BlockEditor.tsx`
- `src/components/portfolio/DescriptionBlocks.tsx`
- `src/components/portfolio/DescriptionBlocksClient.tsx`

---

### Issue #8: Silent API failure - no error UI (UX)
**Location:** Chat interface in project edit page
**Description:**
- User sends message
- API returns 503 error
- No error toast, banner, or message shown to user
- User's message appears in chat bubble, but no response ever comes
- User has no idea what went wrong

**Impact:** High - Confusing user experience
**Fix:** Add error handling in ChatWizardEdit to show toast on API failure

---

## Summary

### Critical Issues (Must Fix)
1. **Issue #6**: Publish button looks enabled but is disabled (no visual feedback)
2. **Issue #7**: Chat API returns 503 (server restart needed)
3. **Issue #8**: Silent API failures (no error UI)

### Medium Issues
4. **Issue #2**: Images missing `sizes` prop (performance)
5. **Issue #5**: Short descriptions (content quality)

### Minor Issues
6. **Issue #3**: "Hmailton" typo (data)
7. **Issue #4**: Truncated quick action chip

---

## Recommended Actions

1. **Immediate**: Restart Next.js dev server to reload env vars
2. **Priority 1**: Fix disabled button styling to show visual disabled state
3. **Priority 1**: Add error handling/toast for API failures
4. **Priority 2**: Add tooltip to Publish button explaining requirements
5. **Priority 3**: Add `sizes` to Image components

---

---

## Deep Agent Testing Results (Session 2)

### Agent Quality Summary

**Tested Scenarios:**
1. Basic project info extraction ✅
2. SEO field generation ✅
3. Multi-field corrections ✅
4. Publish flow ❌

### Issue #9: Client/Server Validation Mismatch (HIGH)
**Location:** Publish button + `/api/projects/[id]/publish`
**Description:**
- Client-side `useCompleteness` hook enables Publish button
- Server-side validation in publish API requires different fields
- Result: Button enabled but publish returns 400 Bad Request

**Server Requirements (from route.ts):**
- title ✅
- project_type + project_type_slug ❌ (missing)
- city + state ❌ (missing)
- at least 1 image ✅
- hero_image_id (auto-set) ✅

**Client Requirements (from useCompleteness):**
- 55% completeness threshold
- At least 1 image
- 80+ chars combined context
- 2+ materials

**Impact:** HIGH - User gets enabled Publish button but publish fails
**Fix:** Align client-side validation with server requirements

---

### Issue #10: Agent Doesn't Update All Required Fields (MEDIUM)
**Location:** Edit mode agent tool calls
**Description:**
When user provides project info, agent updates:
- ✅ title, description, SEO title, SEO description
- ✅ materials, tags
- ❌ project_type (didn't set to "Block Repair")
- ❌ city (didn't set to "Hamilton")
- ❌ state (didn't set to "ON")

**Example:** User said "This was a block repair project in Hamilton" but agent didn't call `updateField` for `project_type` or `city`.

**Impact:** MEDIUM - Project can't be published without these fields
**Fix:** Update agent prompts to always extract and set location/type fields

---

### Issue #11: Chat Auto-Scroll Missing (UX)
**Location:** ChatWizard / ChatMessages components
**Description:**
- After AI responds, user must manually scroll up to see response
- Artifacts and ContentEditor render below viewport
- Constant scrolling required to follow conversation

**Impact:** HIGH - Poor user experience, confusing flow
**Fix:** Add auto-scroll to latest message/artifact on new content

---

### Agent Tool Call Analysis

| Request | Tool Calls | Relevant? | Complete? |
|---------|------------|-----------|-----------|
| "Block repair, 2 weeks, concrete blocks, water damage" | showContentEditor, 3x updateField | ✅ Yes | ⚠️ Partial |
| "Fill SEO fields, add materials" | 3x updateField (seo_title, seo_description, materials) | ✅ Yes | ✅ Yes |
| "Change Toronto→Hamilton, add underground, waterproofing" | 10x updateField | ✅ Yes | ⚠️ Partial |

**Notes:**
- Agent makes relevant tool calls
- Agent handles multi-part requests well
- Agent misses project_type and city/state fields
- Agent is conversational and asks follow-up questions ✅

---

## Updated Test Coverage

| Area | Status | Notes |
|------|--------|-------|
| Login | ✅ Pass | Works with valid credentials |
| Dashboard | ✅ Pass | Stats and projects load correctly |
| Project Edit | ✅ Pass | Chat interface loads |
| Preview Panel | ✅ Pass | Shows project content |
| AI Agent Chat | ✅ Pass | Responds to messages |
| AI Tool Calls | ⚠️ Partial | Misses required fields |
| Publish Button UX | ✅ Fixed | Tooltip shows requirements |
| Actual Publish | ❌ Fail | Client/server validation mismatch |
| Chat Auto-Scroll | ❌ Fail | Must scroll manually |

---

## Screenshots
- Dashboard: See `qa/runs/2025-12-26-dashboard/`
- Additional screenshots available on request
